---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

https://physionet.org/content/mimic2-iaccd/1.0/
# Principe du machine learning

```{r}
library(pander)
# saveRDS(objet, "chemin/objet.rds")
data_tot<- readRDS("data.rds")
str(data_tot)

```

```{r}
library(ggplot2)
library(tidyverse)

```


```{r}
# forcer aléatoire
set.seed(45)
sample_train<-sample(1:dim(data_tot)[1],100,replace = F)
data <- data_tot[sample_train,]

```


## Estimation par regression lin?aire

```{r}
fit1 <- lm(hospital_los_day~sapsi_first, data=data )
summary(fit1)
```

```{r}

data %>% ggplot(aes(x=sapsi_first,y=hospital_los_day))+geom_jitter()+theme_light()
```

```{r}
data %>% ggplot(aes(x=sapsi_first,y=hospital_los_day))+geom_jitter()+theme_light()+
  geom_smooth( method = lm, formula = y ~ x, se = FALSE)

```





```{r}
data %>% ggplot(aes(x=sapsi_first,y=hospital_los_day))+geom_jitter()+theme_light()+
  geom_smooth( method = lm, formula = y ~ poly(x,2), se = FALSE)

```


```{r}
data %>% ggplot(aes(x=sapsi_first,y=hospital_los_day))+geom_jitter()+theme_light()+
  geom_smooth( method = lm, formula = y ~ poly(x,3), se = FALSE)

```


```{r}
library(caret)
fit2 <- lm(hospital_los_day~ poly(sapsi_first, 3, raw = TRUE), data=data )
summary(fit2)
```

```{r}
library(caret)
predictions <- fit2 %>% predict(data)
# Model performance
data.frame(
  RMSE = RMSE(predictions, data$hospital_los_day)
  # R2 = R2(predictions, data$hospital_los_day)
)
```


```{r}

res<-tibble()
for(i in 1:15){
fit2 <- lm(hospital_los_day~ poly(sapsi_first, i, raw = TRUE), data=data )

predictions <- fit2 %>% predict(data)
# Model performance
res<-rbind(res,data.frame(
  i = i,
  RMSE = RMSE(predictions, data$hospital_los_day)
  # R2 = R2(predictions, data$hospital_los_day)
))
}
pander(res)
```


```{r}
plot(res$RMSE)
```


```{r}
res_test<-tibble()
for(i in 1:15){
fit2 <- lm(hospital_los_day~ poly(sapsi_first, i, raw = TRUE), data=data )

predictions <- fit2 %>% predict(data_tot[-sample_train,])
# Model performance
res_test<-rbind(res_test,data.frame(
  i = i,
  RMSE = RMSE(predictions, data_tot[-sample_train,]$hospital_los_day)
  # R2 = R2(predictions, data_tot[-sample_train,]$hospital_los_day)
))
}
pander(res_test)

```


```{r}
analyse_res<- rbind(
 res %>% select(i,RMSE) %>% mutate(data="train"),
 res_test %>% select(i,RMSE) %>% mutate(data="test")
 
)

analyse_res %>% ggplot(aes(x=i, y=RMSE, color=data)) + geom_line()+coord_cartesian(ylim=c(3,4))+theme_light()
```

```{r}
fit2 <- lm(hospital_los_day~ poly(sapsi_first, 8, raw = TRUE), data=data )

predictions <- fit2 %>% predict(data_tot[-sample_train,])

res<- rbind(data.frame(type="pred",
                       y=predictions,
                       x = data_tot$sapsi_first[-sample_train]),
            data.frame(type="réel",
                       y=data_tot$hospital_los_day[-sample_train],
                       x = data_tot$sapsi_first[-sample_train]))

res%>%ggplot(aes(x=x,y=y, color=type))+geom_jitter()+coord_cartesian(ylim =c(-10,20))


```


# Classification binaire


```{r}
  data %>% ggplot(aes(x= bmi, y=age, color = hosp_exp_flg)) +geom_point()
```

```{r}
library(class) ##run knn function
 pr <- knn( data%>% select(age,bmi),data %>% select(age,bmi),cl=data$hosp_exp_flg,k=3)
 
 ##create confusion matrix
 tab <- table(pr,data$hosp_exp_flg)
 
pander(tab)
```

```{r}
caract_test<-function(pred, verite){
  
  VN = sum(!pred& !verite)
  VP = sum(pred& verite)
  FN = sum(!pred & verite)
  FP= sum(pred&!verite)
  return(
    data.frame(specificite = VN/(VN+FP),
      sensibilite = VP/(VP+FN),
      VPP = VP/(VP+FP),
      VPN = VN / (VN+ FN))
  )
}
caract_test(pr==1,data$hosp_exp_flg==1)

```

```{r}
res_train<- tibble()
for(i in 2 : 20){
  pr <- knn( data%>% select(age,bmi),data %>% select(age,bmi),cl=data$hosp_exp_flg,k=i)
 
 ##create confusion matrix
 
 
res_train<-rbind(res_train,data.frame(i=i,caract_test(pr==1,data$hosp_exp_flg==1)))
}

pander(res_train)
```

```{r}
res_test<- tibble()
for(i in 2 : 20){
  pr <- knn( data%>% select(age,bmi),data_tot[-sample_train,] %>% select(age,bmi),cl=data$hosp_exp_flg,k=i)
 
 ##create confusion matrix
 
 
res_test<-rbind(res_test,data.frame(i=i,caract_test(pr==1,data_tot$hosp_exp_flg[-sample_train]==1)))
}

pander(res_test)
```




# Classification binaire

data<-data%>%filter(bmi<50)
```{r}
data %>% ggplot(aes(x= bmi, y=age, color = factor(hosp_exp_flg))) +geom_jitter()+
  theme_light()
```

data %>% ggplot(aes(x= scale(bmi), y=scale(age), color = factor(hosp_exp_flg))) +geom_jitter()+
  theme_light()


```{r}
library(class) ##run knn function
pr <- knn( train = data%>% select(age,bmi),
          test=data %>% select(age,bmi),
           cl=data$hosp_exp_flg,
           k=3)

##create confusion matrix
tab <- table(pr,data$hosp_exp_flg)

pander(tab)
```

```{r}
caract_test<-function(pred, verite){

  VN = sum(!pred& !verite)
  VP = sum(pred& verite)
  FN = sum(!pred & verite)
  FP= sum(pred&!verite)
  VPP = VP/(VP+FP)
  sensibilite = VP/(VP+FN)
  return(
    data.frame(specificite = VN/(VN+FP),
               sensibilite = sensibilite,
               VPP =VPP,
               VPN = VN / (VN+ FN),
               F1score = 2 * sensibilite*VPP/(sensibilite+VPP),
               acc= (VP+VN)/length(verite))
  )
}
caract_test(pr==1,data$hosp_exp_flg==1)

```

```{r}
res_train<- tibble()
for(i in 2 : 20){
  pr <- knn( data%>% select(age,bmi),data %>% 
               select(age,bmi),
             cl=data$hosp_exp_flg,k=i)
  
  ##create confusion matrix
  
  
  res_train<-rbind(res_train,
                   data.frame(i=i,
                              caract_test(pr==1,
                                          data$hosp_exp_flg==1
                                          )))
}

pander(res_train)
```

```{r}
res_test<- tibble()
for(i in 2 : 20){
  pr <- knn( data%>% select(age,bmi),data_tot[-sample_train,] %>% select(age,bmi),cl=data$hosp_exp_flg,k=i)
  
  ##create confusion matrix
  
  
  res_test<-rbind(res_test,data.frame(i=i,caract_test(pr==1,data_tot$hosp_exp_flg[-sample_train]==1)))
}

pander(res_test)
```


```{r}
plot(res_test$F1score)
```


```{r}
pr <- knn( train = data%>% select(age,bmi),
           test=data_tot[-sample_train,]%>% select(age,bmi),
           cl=data$hosp_exp_flg,
           k=2)

```



##create confusion matrix
```{r}
tab1 <- table(pr,data_tot[-sample_train,]$hosp_exp_flg)
tab1

```



```{r}
pr <- knn( train = data%>% select(age,bmi)%>%mutate(bmi=scale(bmi),age=scale(age)),
           test=data_tot[-sample_train,]%>% select(age,bmi)%>%
             mutate(bmi=(bmi-mean(data$bmi))/sd(data$bmi),age=(age-mean(data$age))/sd(data$age)),
           cl=data$hosp_exp_flg,
           k=2)

##create confusion matrix
ta3 <- table(pr,data_tot[-sample_train,]$hosp_exp_flg)
pander(ta3)
```




```{r}
pr <- knn( train = data%>% select(age,bmi),
           test=data %>% select(age,bmi),
           cl=data$hosp_exp_flg,
           k=3)

```




### CV à la main

```{r}
data_tot%>%dim
#Mélanger les données
data_tot<-data_tot[sample(nrow(data_tot)),]

#Séparation en 10 jeu de données
data_tot<-sample(data_tot)
folds <- cut(1:nrow(data_tot),breaks=10,labels=FALSE)
data_tot$folds <- folds 

res=tibble()
for(i in 1:10){
  data_test<- data_tot[folds==i,]
  data_train<- data_tot[!folds==i,]
  
  for(j in 1:5){
    var<- c("age","bmi","sapsi_first","weight_first","creatinine_first")[1:j]
  pr <- knn( train = data_train%>% select(var),
             test=data_test %>% select(var),
             cl=data_train$hosp_exp_flg,
             k=2)

 res<- rbind(res,data.frame(i=1,k=j,  caract_test(pr==1,data_test$hosp_exp_flg==1)))
   }
  
}

res%>%ggplot(aes(y=sensibilite, x= factor(k)))+geom_boxplot()

res%>%pivot_longer(specificite:acc,names_to="score")%>%
  ggplot(aes(y=value, x= factor(k), fill = score))+geom_boxplot()

```       
