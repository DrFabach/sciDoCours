---
title: "R Notebook"
output: html_notebook
---


# Exemple d'entrainement d'algorithme de classification : 

## Jeu de données utilisé BreastCancer : 

```{r}
library(mlbench)
data(BreastCancer)
BDD<- BreastCancer
BDD<- BDD[!duplicated(BDD$Id),]
BDD<- BDD[complete.cases(BDD),]
```


## Description rapide des données

```{r}
library(skimr)
skim(BDD)
```
```{r}
table(BDD$Class)

```


## Garder un jeu de données de test de côté

```{r}
set.seed(42)
ran <- sample(1:nrow(BDD), 0.9 * nrow(BDD)) 
BDD_train  <- BDD[ran,]
BDD_test  <-  BDD[-ran,]




```

## Vérification de la randomisation

```{r}
prop.table(table(BDD_train$Class))
prop.table(table(BDD_test$Class))

```

## Randomisation stratifiée

```{r}
library(dplyr)
set.seed(42)
id_Train <-BDD %>%
    group_by(Class) %>%
    slice_sample(prop=0.9)%>%pull(Id)
BDD_train  <- BDD[BDD$Id %in% id_Train,]
BDD_test  <-  BDD[!BDD$Id %in% id_Train,]

```


```{r}

prop.table(table(BDD_train$Class))
prop.table(table(BDD_test$Class))

```





## Regression logistique simple

```{r}
names(BDD_train)
BDD_train<-BDD_train%>%select(-Id)
```


```{r}
fit <- glm(Class~Cl.thickness+Cell.size, data=BDD_train,family = "binomial")
summary(fit)

#predict(fit,BDD_train)
#predict(fit,BDD_train,type = "response")
table(predict(fit,BDD_train)>0,BDD_train$Class)
table(predict(fit,BDD_train,type = "response")>0.5,BDD_train$Class)

```


```{r}
fit2 <- glm(Class~Cl.thickness+Cell.size, data=BDD_train%>%mutate(Cl.thickness = as.numeric(Cl.thickness), Cell.size = as.numeric(Cell.size)),family = "binomial")
table(predict(fit2,BDD_train%>%mutate(Cl.thickness = as.numeric(Cl.thickness), Cell.size = as.numeric(Cell.size)))>0,BDD_train$Class)
table(predict(fit2,BDD_train%>%mutate(Cl.thickness = as.numeric(Cl.thickness), Cell.size = as.numeric(Cell.size)),type = "response")>0.5,BDD_train$Class)
```


```{r}
fit3 <-  glm(Class~., data=BDD_train,family = "binomial")
summary(fit3)
table(predict(fit3,BDD_train)>0,BDD_train$Class)



```
```{r}
accuracy<- function(table_contingence){
round(sum(diag(table_contingence))/
sum(table_contingence)*100,1)
}
accuracy(table(predict(fit3,BDD_train)>0,BDD_train$Class))
```


## Cross validation

### Modèle 2 variables vs toutes : 

```{r, warning=F}

set.seed(10)
samples<- sample(size = nrow(BDD_train), x = cut(1:nrow(BDD_train),10,labels=FALSE))


res4<- res4_train<-c()
for(sample_i in 1:10){
  BDD_train_i= BDD_train[!samples ==sample_i,]
  BDD_test_i= BDD_train[samples ==sample_i,]
  
  
  fit4 <-  glm(Class~Cl.thickness+Cell.size, data=BDD_train_i,family = "binomial")
  
  acc_train <- accuracy(table(predict(fit4,BDD_train_i)>0,BDD_train_i$Class))
  res4_train<- c(res4_train,acc_train)
  acc<- accuracy(table(predict(fit4,BDD_test_i)>0,BDD_test_i$Class))
  res4<- c(res4,acc)
  
  
}

```





```{r, warning=F}



res5<- res5_train<- c()
for(sample_i in 1:10){
  BDD_train_i= BDD_train[!samples ==sample_i,]
  BDD_test_i= BDD_train[samples ==sample_i,]
  
  
  fit5 <-  glm(Class~., data=BDD_train_i,family = "binomial")
  
    acc_train <- accuracy(table(predict(fit5,BDD_train_i)>0,BDD_train_i$Class))
  res5_train<- c(res5_train,acc_train)
  
  acc<- accuracy(table(predict(fit5,BDD_test_i)>0,BDD_test_i$Class))
  res5<- c(res5,acc)
  
}

```


```{r}
mean(res4_train)
mean(res4)
mean(res5_train)
mean(res5)
```


### Autre modèle

```{r, warning=F}


res6<- res6_train<- c()
for(sample_i in 1:10){
  BDD_train_i= BDD_train[!samples ==sample_i,]
  BDD_test_i= BDD_train[samples ==sample_i,]
BDD_train_i =BDD_train_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  BDD_test_i<-BDD_test_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  
  fit6 <-  glm(Class~., data=BDD_train_i,family = "binomial")
  
    acc_train <- accuracy(table(predict(fit6,BDD_train_i)>0,BDD_train_i$Class))
  res6_train<- c(res6_train,acc_train)
  
  acc<- accuracy(table(predict(fit6,BDD_test_i)>0,BDD_test_i$Class))
  res6<- c(res6,acc)
  
}

```

```{r}
mean(res6_train)
mean(res6)
```

## CV le seuil ? 

  
```{r}
library(ggplot2)
res6_data_frame<- data.frame()
for(sample_i in 1:10){

  BDD_train_i= BDD_train[!samples ==sample_i,]
  BDD_test_i= BDD_train[samples ==sample_i,]
BDD_train_i =BDD_train_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  BDD_test_i<-BDD_test_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  
  fit6 <-  glm(Class~., data=BDD_train_i,family = "binomial")
  
     for( seuil in seq(0,1,0.1)){
  acc<- accuracy(table(predict(fit6,BDD_test_i,type = "response")>seuil,BDD_test_i$Class))
  res6_data_frame<- rbind(res6_data_frame,
                          data.frame(seuil=as.character(seuil), acc=acc)
  )
  }
}
res6_data_frame%>%ggplot(aes(fill=seuil, y=acc))+geom_boxplot()
```




  
```{r}

VPP = function(y_pred, y){ return((sum(y_pred & y)/sum(y_pred))*100)}
VPN = function(y_pred, y){ return((sum(! y_pred&! y)/sum(!y_pred))*100)}


res6_data_frame<- data.frame()
for(sample_i in 1:10){

  BDD_train_i= BDD_train[!samples ==sample_i,]
  BDD_test_i= BDD_train[samples ==sample_i,]
BDD_train_i =BDD_train_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  BDD_test_i<-BDD_test_i%>%mutate_at(vars(Cl.thickness:Epith.c.size), function(x) as.numeric(as.character(x)))
  
  fit6 <-  glm(Class~., data=BDD_train_i,family = "binomial")
  
     for( seuil in seq(0,1,0.1)){
       y_pred = predict(fit6,BDD_test_i,type = "response")>seuil
       y_vrai = as.numeric(BDD_test_i$Class)==2
  acc<- accuracy(table(y_pred, y_vrai))
  res6_data_frame<- rbind(res6_data_frame,
                          data.frame(seuil=as.character(seuil), acc=acc,
                                     VPP = VPP(y_pred,y_vrai),
                                     VPN = VPN(y_pred,y_vrai)
  )
  )
  }
}
library(tidyr)
res6_data_frame%>%pivot_longer(cols = -seuil, names_to = "type",values_to = "score")%>%ggplot(aes(fill=seuil,x=type, y=score))+geom_boxplot()
```
